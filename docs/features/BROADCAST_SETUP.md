# 漂流瓶机器人广播功能设置指南

## 功能概述

广播功能允许机器人向所有加入的群组和频道发送定时宣传消息，帮助推广机器人功能和活跃用户群体。

## 主要特性

### 🤖 自动群组管理
- 自动检测机器人被添加到新群组
- 记录群组信息和活跃状态
- 支持群组管理员控制广播开关

### 📢 定时广播
- **每日活跃推广**: 每天上午10点发送
- **功能更新通知**: 每周三下午3点发送
- **周末活动推广**: 每周五晚上8点发送

### 📊 广播管理
- 广播模板管理
- 发送统计和日志
- 群组状态监控

## 环境配置

### 1. 管理员用户ID设置

在 `.env` 文件中配置管理员用户ID：

```env
# 管理员用户ID，多个用逗号分隔
ADMIN_USER_IDS=123456789,987654321
```

**获取用户ID的方法：**
1. 私聊机器人发送任意消息
2. 查看日志中的用户ID
3. 或使用 @userinfobot 获取自己的用户ID

### 2. 数据库初始化

广播功能需要以下数据库表（启动时自动创建）：
- `chat_groups` - 群组信息表
- `broadcast_templates` - 广播模板表
- `broadcast_logs` - 广播日志表
- `broadcast_schedules` - 广播计划表

## 使用指南

### 群组管理员命令

#### 开启群组广播
```
/broadcast_on
```
- 只有群组管理员可以使用
- 开启后群组将接收定时广播消息

#### 关闭群组广播
```
/broadcast_off
```
- 只有群组管理员可以使用
- 关闭后群组不再接收广播消息

### 超级管理员命令

#### 查看广播模板
```
/admin_broadcast list
```

#### 手动执行广播
```
/admin_broadcast send <模板ID>
```
例如：`/admin_broadcast send 1`

#### 查看广播统计
```
/admin_broadcast stats
```

#### 查看活跃群组
```
/admin_broadcast groups
```

## 广播模板

系统预设了以下广播模板：

### 1. 日常活跃推广
```
🌊 漂流瓶机器人每日活跃中！

📝 在这里你可以：
• 投放漂流瓶，分享你的心情
• 捡拾陌生人的瓶子，发现新世界
• 与有趣的灵魂开始对话
• 通过积分系统获得更多特权

🎯 快来试试吧！发送 /start 开始你的漂流瓶之旅

#漂流瓶 #社交 #交友
```

### 2. 功能更新通知
```
🎉 漂流瓶机器人功能更新！

✨ 新增功能：
• 💰 积分系统：投放、捡拾瓶子获得积分
• 🛒 积分商店：兑换特权和装饰
• 🏆 等级系统：提升等级解锁更多功能
• 👥 好友系统：与志趣相投的人成为朋友

🚀 立即体验：/start

#更新 #新功能
```

### 3. 周末活动推广
```
🎪 周末漂流瓶狂欢！

🎁 特殊活动：
• 双倍积分周末！所有操作获得2倍积分
• 稀有瓶子出现率提升50%
• VIP用户额外获得幸运加成

⏰ 活动时间：本周六日全天
🔥 快来参与，不要错过！

/start 加入活动

#周末活动 #双倍积分
```

## 定时任务配置

广播任务使用 `node-cron` 实现，时区设置为 `Asia/Shanghai`：

```javascript
// 每日活跃推广 (每天上午10点)
cron.schedule('0 10 * * *', async () => {
    // 执行广播逻辑
});

// 周末活动推广 (每周五晚上8点)
cron.schedule('0 20 * * 5', async () => {
    // 执行广播逻辑
});

// 功能更新通知 (每周三下午3点)
cron.schedule('0 15 * * 3', async () => {
    // 执行广播逻辑
});
```

## 监控和日志

### 广播统计
- 总发送数
- 成功率
- 失败原因分析

### 日志记录
- 每次广播的详细记录
- 群组状态变更日志
- 错误和异常日志

### 自动清理
- 每天凌晨3点自动清理30天前的广播日志
- 自动更新失效群组状态

## 最佳实践

### 1. 内容策略
- 保持消息简洁有趣
- 突出机器人核心功能
- 定期更新宣传内容

### 2. 频率控制
- 避免过于频繁的广播
- 根据用户反馈调整时间
- 提供便捷的退订方式

### 3. 群组管理
- 尊重群组管理员的选择
- 提供清晰的功能说明
- 及时处理投诉和反馈

## 故障排除

### 常见问题

#### 1. 广播发送失败
- 检查机器人是否被踢出群组
- 确认机器人有发送消息权限
- 查看错误日志获取详细信息

#### 2. 定时任务不执行
- 检查服务器时区设置
- 确认 cron 表达式正确
- 查看应用程序日志

#### 3. 权限问题
- 确认管理员用户ID配置正确
- 检查群组管理员权限
- 验证机器人在群组中的状态

### 日志查看
```bash
# 查看应用日志
tail -f logs/bot.log

# 查看广播相关日志
grep "广播" logs/bot.log

# 查看错误日志
grep "ERROR" logs/bot.log
```

## 扩展功能

### 自定义广播模板
可以通过数据库直接添加新的广播模板：

```sql
INSERT INTO broadcast_templates (name, content) 
VALUES ('自定义模板', '你的广播内容');
```

### 高级定时配置
可以在 `src/utils/scheduler.ts` 中添加更多定时任务。

### API接口
可以通过HTTP API查看广播统计：
- `GET /api/broadcast/stats` - 广播统计
- `GET /api/broadcast/groups` - 活跃群组列表

## 安全注意事项

1. **管理员权限**: 严格控制超级管理员用户ID
2. **内容审核**: 定期检查广播内容的合规性
3. **频率限制**: 避免被Telegram限制发送频率
4. **隐私保护**: 不在广播中包含用户隐私信息

## 技术支持

如有问题，请查看：
1. 应用程序日志
2. 数据库状态
3. 网络连接情况
4. Telegram API限制

---

*最后更新: 2024年* 