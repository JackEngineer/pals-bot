# 👫 好友申请与私聊功能测试指南

## 新增功能概览
在原有匿名聊天功能基础上，新增了好友申请和私聊功能，让用户可以在匿名聊天基础上进一步发展为真实好友关系。

## 功能特性
1. **智能触发** - 聊天互动达到10条消息后自动显示好友申请按钮
2. **双向选择** - 支持申请添加好友和接受/拒绝申请
3. **信息展示** - 成为好友后可查看对方基本信息
4. **私聊跳转** - 直接跳转到 Telegram 私聊界面
5. **好友管理** - 通过 `/friends` 命令管理好友列表和申请

## 数据库变更
- 新增 `friendships` 表记录好友关系
- 新增 `friend_requests` 表记录好友申请
- 添加相关索引提高查询性能

## 测试步骤

### 准备工作
1. 启动机器人
2. 准备两个不同的Telegram账号（用户A和用户B）
3. 确保两个用户都已完成机器人的初始化

### 基础聊天建立测试
1. **用户A** 投放漂流瓶：`/throw 测试好友功能的漂流瓶`
2. **用户B** 捡拾漂流瓶：`/pick`
3. **用户B** 回复漂流瓶："我想和你聊天！"
4. **用户A** 收到通知，点击"💬 发起聊天"
5. **用户B** 收到邀请，点击"✅ 接受聊天"
6. **验证结果**：
   - 双方都收到聊天开始通知
   - 可以正常发送消息进行匿名聊天

### 消息计数触发测试
1. **用户A和B** 轮流发送消息，确保达到10条消息
   - 用户A发送：1、3、5、7、9 条消息
   - 用户B发送：2、4、6、8、10 条消息
2. **验证结果**：
   - 第10条消息发送后，双方都收到互动选项消息
   - 消息包含"👫 申请添加好友"和"👋 结束聊天"按钮
   - 显示正确的消息计数

### 好友申请发送测试
1. **用户A** 点击"👫 申请添加好友"按钮
2. **验证结果**：
   - 用户A收到"好友申请已发送"确认消息
   - 用户B收到好友申请通知
   - 通知包含"✅ 接受申请"和"❌ 礼貌拒绝"按钮
   - 申请按钮被移除（避免重复申请）

### 好友申请接受测试
1. **用户B** 点击"✅ 接受申请"按钮
2. **验证结果**：
   - 用户B收到接受确认
   - 用户A收到申请被接受的通知
   - 双方都收到"💬 去私聊"和"👤 查看资料"按钮
   - 数据库中正确创建好友关系

### 查看资料功能测试
1. **用户A** 点击"👤 查看资料"按钮
2. **验证结果**：
   - 显示好友的基本信息
   - 包含好友ID、添加时间等信息
   - 显示"💬 私聊"和"❌ 删除好友"按钮

### 私聊跳转功能测试
1. **用户A** 点击"💬 去私聊"或"💬 私聊"按钮
2. **验证结果**：
   - 收到私聊启动通知
   - 包含"📱 打开私聊"按钮，点击后跳转到对方的私聊界面
   - 提示用户可以直接与对方私聊

### 好友申请拒绝测试
1. 重复申请流程，但用户B点击"❌ 礼貌拒绝"
2. **验证结果**：
   - 用户A收到申请被拒绝的通知
   - 用户B收到拒绝确认
   - 没有创建好友关系
   - 可以继续正常匿名聊天

### 好友管理命令测试
1. **用户A** 发送 `/friends` 命令
2. **验证结果**：
   - 显示好友统计信息
   - 列出当前好友列表
   - 显示待处理的好友申请
   - 提供相关提示信息

### 重复申请防护测试
1. 在已有待处理申请的情况下，用户A再次尝试申请
2. **验证结果**：
   - 系统提示"已有待处理的好友申请"
   - 不创建重复申请
   - 保持原有申请状态

### 已是好友检测测试
1. 在双方已是好友的情况下，尝试再次申请
2. **验证结果**：
   - 系统提示"你们已经是好友了"
   - 不显示好友申请按钮
   - 可以直接使用好友功能

### 删除好友功能测试
1. **用户A** 在好友资料中点击"❌ 删除好友"
2. **验证结果**：
   - 收到删除确认消息
   - 好友关系被移除
   - 双方不再互为好友

### 聊天中断后的申请测试
1. 在显示申请按钮后，用户A点击"👋 结束聊天"
2. **验证结果**：
   - 聊天会话正常结束
   - 申请按钮被移除
   - 双方收到聊天结束通知

## 预期结果
- ✅ 消息计数准确，按设定阈值显示按钮
- ✅ 好友申请流程完整无误
- ✅ 申请接受/拒绝功能正常
- ✅ 好友信息展示正确
- ✅ 私聊跳转功能有效
- ✅ 好友管理命令正常工作
- ✅ 重复申请和已是好友的检测有效
- ✅ 删除好友功能正常
- ✅ 错误处理机制完善

## 技术实现
- 创建了 `FriendService` 处理好友关系逻辑
- 扩展了 `ChatService` 添加消息计数功能
- 在 `NotificationService` 中添加好友申请相关通知
- 更新了 `bot/commands.ts` 添加完整的好友流程处理
- 添加了好友关系和申请的数据库表
- 实现了 `/friends` 命令进行好友管理

## 隐私与安全
- 好友申请仍保持匿名性
- 只有成为好友后才能查看基本信息
- 用户可以随时拒绝申请或删除好友
- 私聊跳转需要用户主动点击确认
- 支持删除好友关系

## 错误处理
- 网络异常时的优雅降级
- 数据库操作失败的回滚机制
- 用户权限检查
- 重复操作的防护
- 异常状态的恢复机制

## 后续优化建议
1. 添加好友备注功能
2. 支持好友分组管理
3. 添加好友动态和互动历史
 