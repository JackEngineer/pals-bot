# 🌊 漂流瓶机器人 (Pals Bot)

一个基于Telegram的漂流瓶社交机器人，现已集成完整的积分系统！让用户在投放和捡拾漂流瓶的过程中体验游戏化的乐趣。

## ✨ 主要特性

### 📝 基础功能
- **投放漂流瓶** - 分享你的心情、想法、故事
- **随机捡拾** - 发现来自世界各地的消息
- **互动回复** - 与陌生人进行温暖的交流
- **🔔 实时通知** - 收到回复时立即通知原作者
- **📜 完整对话** - 查看漂流瓶的完整回复历史
- **多媒体支持** - 支持文字、图片、语音、视频
- **🎯 一键操作** - 按钮式交互，告别复杂命令输入

### 💰 积分系统
- **多种获取方式** - 投放(+10)、捡拾(+5)、回复(+8)、收到回复(+3)
- **每日签到** - 连续签到获得更多奖励
- **时间加成** - 深夜活跃1.5倍积分，周末1.2倍积分
- **VIP倍数** - VIP会员享受1.2倍积分加成

### 🏆 等级系统
- **🌊 新手水手** (0-99积分) - 基础功能
- **⚓ 见习船员** (100-299积分) - 解锁基础商品
- **🚢 资深航海者** (300-599积分) - 解锁高级商品，消息带⚓标识
- **🏴‍☠️ 海洋探索家** (600-999积分) - 解锁专属商品，🏴‍☠️标识
- **👑 漂流瓶大师** (1000+积分) - 全部功能，👑标识

### 🛒 积分商店
#### 功能特权类
- **💎VIP会员** (200积分/30天) - 1.2倍积分、签到+3、特效标识
- **📝额外投放次数** (100积分/1天) - 每日+5次投放限制
- **🚫无冷却投放** (150积分/24小时) - 跳过投放时间限制
- **🎯选择性捡拾** (300积分/7天) - 可跳过不喜欢的瓶子

#### 体验增强类
- **🎨彩色消息** (50积分/7天) - 漂流瓶带特殊装饰
- **📝自定义签名** (100积分/30天) - 个性化签名显示
- **🕶️匿名保护** (80积分/24小时) - 隐藏用户名
- **🔐消息加密** (200积分/次) - 限定等级可见

#### 特殊物品类
- **💫双倍积分卡** (250积分/24小时) - 所有行为双倍积分
- **🍀幸运加成** (200积分/24小时) - 稀有瓶子概率+20%
- **⭐回复优先** (100积分/24小时) - 瓶子更容易被看到

### 🏅 成就系统
- **🎉初次航行** - 投放第一个漂流瓶 (+20积分)
- **🏆投放达人** - 累计投放100个漂流瓶 (+100积分)
- **💬回复专家** - 累计回复50个漂流瓶 (+80积分)
- **🦋社交达人** - 与20个不同用户互动 (+150积分)
- **🔥签到达人** - 连续签到7天 (+50积分)

## 🎮 使用指南

### 基础命令
```
/start - 开始使用机器人
/help - 查看详细帮助
/throw <内容> - 投放漂流瓶
/pick - 随机捡拾漂流瓶 (支持按钮操作)
/reply <瓶子ID> <内容> - 回复漂流瓶 (推荐使用按钮)
```

### 积分系统命令
```
/points - 查看积分和等级
/checkin - 每日签到
/shop - 浏览积分商店
/buy <商品ID> - 购买商品
/leaderboard - 积分排行榜
/achievements - 我的成就列表
/vip - VIP专属功能面板
```

### 统计命令
```
/stats - 个人统计信息
/global - 全局统计信息
/status - 机器人运行状态
```

### 💡 新功能：一键操作体验
当你使用 `/pick` 命令捡到漂流瓶后，无需再手动输入复杂的回复命令：
- 🎯 **点击「💬 回复漂流瓶」按钮** - 自动进入回复模式，支持强制回复提示
- 🎣 **点击「🎣 继续捡拾」按钮** - 一键继续捡拾更多漂流瓶
- 📝 **智能输入提示** - 使用 Telegram 的 force_reply 功能，提供更好的输入体验
- ⚡ **实时状态管理** - 系统自动记录回复状态，无需重复操作

这个功能大大简化了用户的操作流程，从原来的：
```
1. /pick 捡拾漂流瓶
2. 手动复制瓶子ID
3. 手动输入 /reply 瓶子ID 回复内容
```
简化为：
```
1. /pick 捡拾漂流瓶
2. 点击回复按钮
3. 直接输入回复内容
```

## 🚀 技术架构

### 核心技术栈
- **Runtime**: Node.js 18+
- **Language**: TypeScript
- **Framework**: Telegraf (Telegram Bot API)
- **Database**: SQLite3 + 事务安全
- **Web Server**: Express.js
- **Scheduling**: node-cron

### 项目结构
```
src/
├── bot/                # 机器人逻辑
│   ├── commands.ts     # 命令处理器
│   └── handlers.ts     # 消息处理器
├── services/           # 业务服务
│   ├── database.ts     # 数据库服务
│   ├── bottle-service.ts # 漂流瓶服务
│   └── points-service.ts # 积分系统服务
├── types/              # TypeScript类型定义
├── utils/              # 工具函数
│   ├── logger.ts       # 日志工具
│   ├── scheduler.ts    # 定时任务
│   └── message-formatter.ts # 消息格式化
└── index.ts           # 主入口文件
```

### 数据库设计
- **bottles** - 漂流瓶主表
- **replies** - 回复表
- **user_stats** - 用户统计
- **user_points** - 用户积分
- **points_transactions** - 积分交易记录
- **points_shop_items** - 商店商品
- **user_purchases** - 购买记录
- **achievements** - 成就配置
- **user_achievements** - 用户成就

## 🛠️ 安装部署

### 环境要求
- Node.js 18+
- npm 或 yarn
- SQLite3

### 快速开始
1. **克隆项目**
```bash
git clone <repository-url>
cd pals-bot
```

2. **安装依赖**
```bash
npm install
```

3. **配置环境变量**
```bash
cp env.example .env
# 编辑 .env 文件，填入你的 Bot Token
```

4. **构建项目**
```bash
npm run build
```

5. **启动机器人**
```bash
npm start
```

### 环境变量配置
```env
# Telegram Bot配置
BOT_TOKEN=your_telegram_bot_token
PROXY_URL=socks5://127.0.0.1:1080  # 可选，代理配置

# 数据库配置
DATABASE_PATH=./data/bot.db

# 业务配置
MAX_BOTTLES_PER_DAY=5              # 每日基础投放限制
MAX_BOTTLE_CONTENT_LENGTH=1000     # 漂流瓶内容最大长度

# 服务器配置
PORT=3000
NODE_ENV=production
```

### PM2部署 (推荐)
```bash
# 启动
npm run pm2:start

# 停止
npm run pm2:stop

# 重启
npm run pm2:restart

# 查看日志
npm run pm2:logs
```

## 📊 API接口

### 排行榜API
```
GET /api/leaderboard?limit=10
```

### 商店商品API
```
GET /api/shop?category=privilege
```

### 机器人状态API
```
GET /bot/status
```

### 健康检查API
```
GET /health
```

## 🎯 积分获取策略

### 日常活动
- 每日签到：+5积分起（等级越高越多）
- 投放漂流瓶：+10积分
- 捡拾漂流瓶：+5积分
- 回复漂流瓶：+8积分
- 收到回复：+3积分

### 特殊奖励
- 连续签到7天：+20积分
- 连续签到30天：+100积分
- 人气瓶子（10个回复）：+50积分
- 解锁成就：+20-150积分

### 倍数加成
- 深夜活跃 (22:00-06:00)：×1.5
- 周末活跃：×1.2
- VIP会员：×1.2
- 双倍积分卡：×2.0

## 🔧 维护与监控

### 定时任务
- **每小时** - 清理过期购买记录
- **每日1点** - 重置每日限制
- **每周一2点** - 生成周报数据

### 日志系统
- 使用Winston记录详细日志
- 支持文件和控制台输出
- 错误日志自动记录用户操作

### 性能优化
- SQLite WAL模式提高并发性能
- 数据库连接池管理
- 重试机制处理并发冲突
- 索引优化查询性能

## 🤝 贡献指南

1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情

## 🆘 支持与反馈

如果你在使用过程中遇到问题或有建议，请：
- 提交 Issue
- 加入讨论群
- 发送邮件联系

---

💝 感谢使用漂流瓶机器人！希望它能为你带来有趣的社交体验！
